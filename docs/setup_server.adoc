= Setup web site powered by giblish
:imagesdir: setup_server_assets
:numbered:

== Purpose

To describe how to use giblish as a tool in creating a static web site with documents automatically generated from a git repo.

This text covers two deployment scenarios; one using git hooks only, and one using a combination of git hooks and Jenkins. It has only been tested on Linux servers (Ubuntu). Most of the tools and scripts should work on a Windows server as well but might need some tweaking and is, again, not tested.

== Deploy using git hooks only

This requires the least number of installed components to work. An overview of the scenario is given below.

.Deploy using git hooks only
image::deploy_with_hooks.svg[]

The components needed on the server are:

Master Repo::
The common (bare) git repo used by all content writers to push updates to. This repo needs to be setup with a server-side hook (_post-receive_) that are executed by git after each push to the repository.

Staging Repo::
A git repo that mirrors the _Master Repo_ and fulfills two functions:

 . provide a checked-out working tree with the source files (adoc files).
 . provide a script that uses giblish to publish the adoc files in the working tree as HTML files that reside at a place in the file system where the web server can access them.

Web Server::
Apache, Ngnix or other web server that provides clients with HTML pages located somewhere on the file system on the server (typically under /var/www/... )

=== Considerations when choosing this scenario

Possible advantages::
 * it has few dependencies on external tools, only git, giblish and a web server are needed for this to work.
 * giblish provides templates for both the `post-receive` hook and the `publish_html` script that easily can be tailored to your specific setup.

Possible drawbacks::
 * The hook and publish scripts provided with giblish runs *syncronously* at each push from a _Doc Writer_ to the _Master Repo_. The time it takes to generate the HTML docs from the adoc source will thus be added to each push to the _Master Repo_.
 * You need to manually setup the _Staging Repo_ on the server and this is a bit more 'hackish' than letting a build orchestrator tool handle this.
 * The `publish_html` script provided with giblish only uses the currently checked-out branch on the _Staging Repo_ (typically 'master') to generate the HTML docs. It is non-trivial to add multiple-branch generation to the provided script.

=== The setup process

git and gitrepo setup::
 . Install git on the _Server_.
 . Setup the *bare* _Master Repo_ on the _Server_ by either.
 .. Copy a bare repo you already use to the _Server_ file system.
 .. Init a new repo using `git init --bare <your_repo_name>` somewhere on the _Server_ file system.
+
NOTE: If you start with an empty, bare _Master Repo_ on the _Server_, it is a good idea to directly clone it to your local machine, commit some content to the 'master' branch and push the result back to the _Master Repo_. An empty, bare repo does not even contain a 'master' branch from the start and this can lead to some edge cases that complicates things.

 . Setup the _Staging Repo_ on the _Server_ by cloning the _Master Repo_ using `git clone \file://<file-system-location-of-master-repo` to a suitable place in the _Server's_ file system.

Now you should have all the necessary git repositories in place on the server. They are however, not 'connected' via hooks and scripts yet.

giblish setup::
 . Install ruby on the _Server_ (a version no more than 18 months old)
 . Install giblish on the _Server_ using `gem install giblish`

script setup::
 . Find out where the template scripts for the `post-receive` and the `publish_html.sh` scripts are located by running `gem which giblish`. Strip of the `lib/giblish.rb` from the end of the returned path and `cd` to the resulting folder. There should be a subfolder named `scripts` under which you can find the template scripts somewhere.
+
.Installation on Ubuntu 16.04
====
On a server running Ubuntu 16.04, `gem which giblish` returns:

 /var/lib/gems/2.6.0/gems/giblish-0.7.0/lib/giblish.rb

and the template scripts can thus be found somewhere under

 /var/lib/gems/2.6.0/gems/giblish-0.7.0/scripts
====

 . Copy the `publish_html.sh` script to a suitable folder in your _local repo_ on your _local machine_ (e.g. under `<your_local_repo_root>/scripts`).
 . Tweak the configuration variables in the script to fit your use case.
 . Commit and push script to the _Master Repo_ on the _Server_.
 . Copy the `post-receive` script to the `hooks` folder in your bare _Master Repo_.
 . Tweak the configuration variables of the copy to suite your use case.
 . Set the execute permission using `chmod +x post-receive`

stylesheet setup::
The template scripts assume that the the css used to style the generated HTML is located under `<repo_root>/scripts/resources/css` and is called `giblish.css`. To enable a styling of your liking, either create this folder/css file in your repo at that exact place or tweak the `html_publish.sh` script to use another location/css file name for the styling.


== Deploy using Jenkins

This setup adds a Jenkins (or similar build orchestrator) installation so it is more to setup but is more 'production friendly'.



















.Deploy using Jenkins
image::deploy_with_jenkins.svg[]
















== Toolchain

 * git
 * giblish
 * git server side hooks to kick-off the document rendering after a git push.
 * a web server to publish the rendered html documents.
รถ* a tool that can execute scripts after a git push. *Jenkins* is used in this instruction. Some advantages over calling giblish directly from a git hook:
 ** the document rendering is asynchronous to the git push from the client.
 ** the script executed by Jenkins (the 'pipeline' in Jenkis lingo) can be stored and versioned in the same git repo as the documents to be rendered.

=== Sequence for rendering documents

The following image shows how the sequence from user commit to rendered documents.

image::Render Documents.png[]

=== Sequence for viewing documents

This is just the standard way of accessing a web site. The html page served by the web server will be the latest generated html page.

image::View Documents.png[]

== Server requirements

The server that will render the documents need the following tools installed:

 * git
 * giblish

The server that runs Jenkins will (of course) need Jenkins installed.

=== Setup server for both Jenkins and doc rendering on Ubuntu 16.04

The easiest setup is to use the same server to run Jenkins and to render the documents. For an Ubuntu 16.04 installation, you can install the needed tools as follows:

 * install git `sudo apt install git`
 * install Jenkins See https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-16-04[this doc].
 * install giblish `sudo gem install giblish`


== server side git hooks

git supports hooks in several parts of the sequence of getting changes ommitted and pushed to a remote repo. For details on git hooks see https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks[this doc]. See <<post-update-hook>> An example of a `post-update` hook that triggers Jenkins


[appendix]
[[post-update-hook]]
== post-update hook

Below is an example of a `post-update` hook that triggers Jenkins jobs after a push to a git repo. This hook should be installed on the server side git repository to trigger Jenkins builds

.Example of a git hook triggering Jenkins builds
----
include::../docgen/scripts/githook_examples/post-update.example[]
----

== Jenkins pipeline script

Below is a very basic example of a Jenkins pipeline that triggers giblish to render html and pdf documents located in a specific directory in a git repository.
